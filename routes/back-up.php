
    $payload  =  <<<PAYLOAD
    {"id":11401,"parent_id":0,"status":"pending","currency":"GBP","version":"5.6.0","prices_include_tax":false,"date_created":"2022-01-15T11:55:35","date_modified":"2022-01-18T11:55:35","discount_total":"0.00","discount_tax":"0.00","shipping_total":"19.99","shipping_tax":"0.00","cart_tax":"0.00","total":"25.99","total_tax":"0.00","customer_id":203,"order_key":"wc_order_TK9Q83rKj3XRL","billing":{"first_name":"Mustapha","last_name":"Alaba","company":"Rede Hub","address_1":"23A, Kauna Avenue, Kurmin Mashi","address_2":"Kurmin Mashi","city":"Kaduna","state":"KD","postcode":null,"country":"NG","email":"redehubng@gmail.com","phone":"+2348095034525"},"shipping":{"first_name":"Mustapha","last_name":"Alaba","company":"Rede Hub","address_1":"23A, Kauna Avenue, Kurmin Mashi","address_2":"Kurmin Mashi","city":"Kaduna","state":"KD","postcode":null,"country":"NG","phone":null},"payment_method":"sagepayform","payment_method_title":"Credit Card via Opayo","transaction_id":null,"customer_ip_address":"41.190.12.212","customer_user_agent":"Mozilla\/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/97.0.4692.71 Safari\/537.36","created_via":"checkout","customer_note":null,"date_completed":null,"date_paid":null,"cart_hash":"0b8771c315112f06436dcdd9fe209a39","number":"11401","meta_data":[{"id":66784,"key":"is_vat_exempt","value":"no"},{"id":66785,"key":"_ivole_cr_consent","value":"no"},{"id":66786,"key":"_esig_after_checkout_doc_list","value":"[]"}],"line_items":[{"id":412,"name":"UK Roaming SIM 12 Month Contract (Copy)","product_id":11360,"variation_id":11363,"quantity":2,"tax_class":null,"subtotal":"6.00","subtotal_tax":"0.00","total":"6.00","total_tax":"0.00","taxes":[],"meta_data":[{"id":3073,"key":"sim-type","value":"mini (2FF)","display_key":"SIM Type","display_value":"mini (2FF)"},{"id":3074,"key":"pa_data","value":"1mb","display_key":"Data","display_value":"1MB +\u00a30.47"},{"id":3075,"key":"_sms_mo_qty","value":"2","display_key":"_sms_mo_qty","display_value":"2"},{"id":3076,"key":"_sms_mt_qty","value":"2","display_key":"_sms_mt_qty","display_value":"2"},{"id":3077,"key":"_sms_plan","value":"1","display_key":"_sms_plan","display_value":"1"},{"id":3078,"key":"Pool summary","value":"<table class='sms_plan_cart_table' style='margin-top: 10px'>
\t\t<thead>
\t\t\t<tr>
\t\t\t\t<th>Base Data Plan <\/th>
\t\t\t\t<th>Price<\/th>
\t\t\t<\/tr>
\t\t<\/thead>
\t\t<tbody>
\t\t\t<tr class='sms_plan_tr'>
\t\t\t\t<td>1MB<\/td>
\t\t\t\t<td><span class=\"woocommerce-Price-amount amount\"><bdi><span class=\"woocommerce-Price-currencySymbol\">&pound;<\/span>0.47<\/bdi><\/span><\/td>
\t\t\t<\/tr>
\t\t<\/tbody>
\t<\/table>

\t<table class='sms_plan_cart_table'>
\t\t<tbody>
\t\t\t<tr class='thead'>
\t\t\t\t<td>Monthly pooled Allowances: <\/td>
\t\t\t\t<td>Quantity<\/td>
\t\t\t<\/tr>
\t\t\t<tr class='sms_plan_tr'>
\t\t\t\t<td>Total Data MB<\/td>
\t\t\t\t<td>2<\/td>
\t\t\t<\/tr>
\t\t\t<tr>
\t\t\t\t<td>Total SMS MO<\/td>
\t\t\t\t<td>4<\/td>
\t\t\t<\/tr>
\t\t\t<tr>
\t\t\t\t<td>Total SMS MT<\/td>
\t\t\t\t<td>4<\/td>
\t\t\t<\/tr>
\t\t<\/tbody>
\t<\/table>
\t<table class='sms_plan_cart_table'>
\t
\t\t<tbody>
\t\t\t<tr class='thead'>
\t\t\t\t<td>Product<\/td>
\t\t\t\t<td>Price<\/td>
\t\t\t\t<td>Quantity<\/td>
\t\t\t\t<td>Subtotal<\/td>
\t\t\t<\/tr>
\t\t\t<tr>
\t\t\t\t<td>Base Data MB<\/td>
\t\t\t\t<td><span class=\"woocommerce-Price-amount amount\"><bdi><span class=\"woocommerce-Price-currencySymbol\">&pound;<\/span>0.47<\/bdi><\/span><\/td>
\t\t\t\t<td>2<\/td>
\t\t\t\t<td><span class=\"woocommerce-Price-amount amount\"><bdi><span class=\"woocommerce-Price-currencySymbol\">&pound;<\/span>0.94<\/bdi><\/span><\/td>
\t\t\t<\/tr>
\t\t\t<tr>
\t\t\t\t<td>SMS MO (Mobile Originated)<\/td>
\t\t\t\t<td><span class=\"woocommerce-Price-amount amount\"><bdi><span class=\"woocommerce-Price-currencySymbol\">&pound;<\/span>0.10<\/bdi><\/span><\/td>
\t\t\t\t<td>4<\/td>
\t\t\t\t<td><span class=\"woocommerce-Price-amount amount\"><bdi><span class=\"woocommerce-Price-currencySymbol\">&pound;<\/span>0.40<\/bdi><\/span><\/td>
\t\t\t<\/tr>
\t\t\t<tr>
\t\t\t\t<td>SMS MT (Mobile Terminated)<\/td>
\t\t\t\t<td><span class=\"woocommerce-Price-amount amount\"><bdi><span class=\"woocommerce-Price-currencySymbol\">&pound;<\/span>0.10<\/bdi><\/span><\/td>
\t\t\t\t<td>4<\/td>
\t\t\t\t<td><span class=\"woocommerce-Price-amount amount\"><bdi><span class=\"woocommerce-Price-currencySymbol\">&pound;<\/span>0.40<\/bdi><\/span><\/td>
\t\t\t<\/tr>
\t\t\t<tr>
\t\t\t\t<td colspan='3' style='text-align: right'><strong>Total Monthly Billing<\/strong><\/td>
\t\t\t\t<td><span class=\"woocommerce-Price-amount amount\"><bdi><span class=\"woocommerce-Price-currencySymbol\">&pound;<\/span>1.74<\/bdi><\/span><\/td>
\t\t\t<\/tr>
\t\t\t
\t\t<\/tbody>
\t<\/table>","display_key":"Pool summary","display_value":"Base Data Plan Price 1MB &pound;0.47 Monthly pooled Allowances: Quantity Total Data MB 2 Total SMS MO 4 Total SMS MT 4 Product Price Quantity Subtotal Base Data MB &pound;0.47 2 &pound;0.94 SMS MO (Mobile Originated) &pound;0.10 4 &pound;0.40 SMS MT (Mobile Terminated) &pound;0.10 4 &pound;0.40 Total Monthly Billing &pound;1.74"}],"sku":"UK-MINI-2FF-SIM-5","price":3,"parent_name":"UK Roaming SIM 12 Month Contract (Copy)"}],"tax_lines":[],"shipping_lines":[{"id":413,"method_title":"Wordwide Shipping Rate for Standard Size Package","method_id":"flat_rate","instance_id":"4","total":"19.99","total_tax":"0.00","taxes":[],"meta_data":[{"id":3084,"key":"Items","value":"UK Roaming SIM 12 Month Contract (Copy) &times; 2","display_key":"Items","display_value":"UK Roaming SIM 12 Month Contract (Copy) &times; 2"}]}],"fee_lines":[],"coupon_lines":[],"refunds":[],"date_created_gmt":"2022-01-18T11:55:35","date_modified_gmt":"2022-01-18T11:55:35","date_completed_gmt":null,"date_paid_gmt":null,"currency_symbol":"\u00a3","_links":{"self":[{"href":"https:\/\/blueprint.m2mdataconnect.com\/wp-json\/wc\/v3\/orders\/11401"}],"collection":[{"href":"https:\/\/blueprint.m2mdataconnect.com\/wp-json\/wc\/v3\/orders"}],"customer":[{"href":"https:\/\/blueprint.m2mdataconnect.com\/wp-json\/wc\/v3\/customers\/203"}]}}
PAYLOAD;

$payloadDecode = preg_replace('/[[:cntrl:]]/', '', $payload);
$order_data = json_decode($payloadDecode, true);



$order_date = $order_data['date_created'];
$date_completed = $order_data['date_completed'];

$order_date = explode('T', $order_date);
$order_date = implode(" ", $order_date);

$date_completed = explode('T', $date_completed);
$date_completed = implode(" ", $date_completed);


// $order_date_carbon = Carbon("yyyy-MM-dd HH:mm:ss", $order_date);
$order_date_carbon = new Carbon($order_date, 'Europe/London');
$date_completed_carbon = new Carbon($date_completed, 'Europe/London');

if($order_date_carbon->day < 7){
    $prorated_days = 7 - $order_date_carbon->day; //days to 7th of the current month
    $next_order_date = $order_date_carbon->addDays($prorated_days);
}else if($order_date_carbon->day > 7){
    $prorated_days = ($order_date_carbon->daysInMonth + 7) - $order_date_carbon->day; //days to 7th of next month
    $next_order_date = $order_date_carbon->addDays($prorated_days);
}else{
    $prorated_days = 0;
    $next_order_date = $order_date_carbon;
}

$order_status = $order_data["status"];
$order_id = $order_data["id"];
$customer_id = $order_data["customer_id"];
$order_total = $order_data["total"];
$billing_info = $order_data["billing"];


// Get all line items from order
$line_items = [];
foreach($order_data["line_items"] as $line_item){

    $line_item_meta_data = $line_item["meta_data"];

    $line_pool_summary = Arr::first($line_item_meta_data, function ($value, $key) {
        return $value["key"] == "Pool summary";
    });

    $line_pool_summary_table = $line_pool_summary["value"];
    $crawler = new Crawler($line_pool_summary_table);


    $base_mb = $crawler->filter(".sms_plan_cart_table:nth-of-type(1) tbody .sms_plan_tr td:nth-of-type(1)")->text();
    $base_mb_price = $crawler->filter(".sms_plan_cart_table:nth-of-type(1) tbody .sms_plan_tr td:nth-of-type(2)")->text();


    $total_monthly_mb = $crawler->filter(".sms_plan_cart_table:nth-of-type(2) tbody tr:nth-of-type(2) td:nth-of-type(2)")->text();
    $total_monthly_mb_price = $crawler->filter(".sms_plan_cart_table:nth-of-type(2) tbody tr:nth-of-type(3) td:nth-of-type(2)")->text();



    if($prorated_days > 0){
        $total_prorated_mb = ($total_monthly_mb / 30) * $prorated_days;
        $total_prorated_mb_price = ($total_monthly_mb_price / 30) * $prorated_days;
    }else{
        $total_prorated_mb = 0;
        $total_prorated_mb_price = 0;
    }

    $total_prorated_mb = round($total_prorated_mb, 2);
    $total_prorated_mb_price = round($total_prorated_mb_price, 2);



    $sms_mt_base_price = $crawler->filter(".sms_plan_cart_table:nth-of-type(3) tbody tr:nth-of-type(3) td:nth-of-type(2)")->text();
    $sms_mt_base_price = (float)ltrim($sms_mt_base_price, '£');

    $sms_mt_qty = $crawler->filter(".sms_plan_cart_table:nth-of-type(3) tbody tr:nth-of-type(3) td:nth-of-type(3)")->text();

    $sms_mt_total_price = $crawler->filter(".sms_plan_cart_table:nth-of-type(3) tbody tr:nth-of-type(3) td:nth-of-type(4)")->text();
    $sms_mt_total_price = (float)ltrim($sms_mt_total_price, '£');

    $sms_mt_prorated_qty = ($sms_mt_qty / 30) * $prorated_days;
    $sms_mt_prorated_total_price = ($sms_mt_total_price / 30) * $prorated_days;



    $sms_mo_base_price = $crawler->filter(".sms_plan_cart_table:nth-of-type(3) tbody tr:nth-of-type(4) td:nth-of-type(2)")->text();
    $sms_mo_base_price = (float)ltrim($sms_mo_base_price, '£');

    $sms_mo_qty = $crawler->filter(".sms_plan_cart_table:nth-of-type(3) tbody tr:nth-of-type(4) td:nth-of-type(3)")->text();

    $sms_mo_total_price = $crawler->filter(".sms_plan_cart_table:nth-of-type(3) tbody tr:nth-of-type(4) td:nth-of-type(4)")->text();
    $sms_mo_total_price = (float)ltrim($sms_mo_total_price, '£');

    $sms_mo_prorated_qty = ($sms_mo_qty / 30) * $prorated_days;
    $sms_mo_prorated_total_price = ($sms_mo_total_price / 30) * $prorated_days;



    $summary = [
        "line_id" => $line_item["id"],
        "product_name" => $line_item["name"],
        "product_id" => $line_item["product_id"],
        "variation_id" => $line_item["variation_id"],
        "quantity" => $line_item["quantity"],
        "base_mb" => $base_mb,
        "prorated_days" => $prorated_days,
        "base_mb_price" => $base_mb_price,
        "total_monthly_mb" => $total_monthly_mb,
        "total_monthly_mb_price" => $total_monthly_mb_price,
        "total_prorated_mb" => $total_prorated_mb,
        "total_prorated_mb_price" => $total_prorated_mb_price,
        "sms_mt_base_price" => $sms_mt_base_price,
        "sms_mt_qty" => $sms_mt_qty,
        "sms_mt_total_price" => $sms_mt_total_price,
        "sms_mt_prorated_qty" => $sms_mt_prorated_qty,
        "sms_mt_prorated_total_price" => $sms_mt_prorated_total_price,
        "sms_mo_base_price" => $sms_mo_base_price,
        "sms_mo_qty" => $sms_mo_qty,
        "sms_mo_total_price" => $sms_mo_total_price,
        "sms_mo_prorated_qty" => $sms_mo_prorated_qty,
        "sms_mo_prorated_total_price" => $sms_mo_prorated_total_price
    ];

    array_push($line_items, $summary);
}


    $order = Order::create([
        "order_id" => $order_id,
        "customer_id" => $customer_id,
        "status" => $order_status,
        "date" => $order_date,
        "date_completed" => $date_completed,
        "total" => $order_total,
        "billing_info" => json_encode($billing_info),
        "line_items" => json_encode($line_items),
        "last_invoice_date" => null,
        "prorated_days" => $prorated_days,
    ]);

    dd($order);
